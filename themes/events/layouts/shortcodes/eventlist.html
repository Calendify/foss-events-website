{{- $type := .Get "type" -}} <!-- options: year, range -->
{{- $date := .Get "date" -}} <!-- options: all, YYYY, next_12m, prev_12m, next_all, prev_all -->
{{- $month_counter := "0" -}} <!-- set to non-existing month number to let month name display initially -->
{{- $cfp := .Get "cfp" -}}
{{- $cfp_link := .Get "cfp_link" -}}
{{- $cfp_date := .Get "cfp_date" -}}

{{ $url := "events_db.csv" }}
{{ $sep := "	" }}

<!-- range over all pages whose front matter holds "event: true", sorted by date_start -->
{{ range $i, $r := (after 1 (getCSV $sep $url)) }}
  {{- $display := 0 -}} <!-- by default, event will not be displayed -->
  {{- $tsr := (index $r 0) -}}
  {{- $tss := (printf "%s-%s-%s" (substr $tsr 0 4) (substr $tsr 4 2) (substr $tsr 6 2)) -}}
  {{- $ts := (time $tss) -}}
  {{- $ter := (index $r 1) -}}
  {{- $tes := (printf "%s-%s-%s" (substr $tsr 0 4) (substr $tsr 4 2) (substr $tsr 6 2)) -}}
  {{- $te := (time $tes) -}}
  {{- $day := dateFormat "02" $ts -}}
  {{- $end_day := dateFormat "02" $te -}}
  {{- $month := dateFormat "January" $ts -}} <!-- event date as month name -->
  {{- $year := dateFormat "06" $ts -}} <!-- event date as month number-->
  {{- $month_no := dateFormat "01" $ts -}} <!-- 01 is 2-digit month -->
  {{- $range_next := now.AddDate 1 0 0 -}} <!-- date in 12 months as limit for "range next" -->
  {{- $range_prev_diff := now.Sub $ts -}} <!-- difference between now and event start -->
  {{- $title := (index $r 3) -}}

  {{- $city := (index $r 10) -}}
  {{- $homepage := (index $r 6) -}}

  {{- /* <!-- evaluate whether to show event. if so, set $display = 1 --> */ -}}
  {{- if eq $type "year" -}} <!-- type = year -->
    {{- if eq $ts.Year (int $date) -}}
      {{- $display = 1 -}}
    {{- end -}}
  {{- else if eq $type "range" -}} <!-- type = range -->
    {{- if eq $date "next_12m" -}} <!-- date = next_12m -->
      {{- /* <!-- between now and +1 year --> */ -}}
      {{- if and ($ts.After now) ($ts.Before $range_next) -}}
        {{- $display = 1 -}}
      {{- end -}}
    {{- else if eq $date "prev_12m" -}} <!-- date = prev_12m -->
      {{- /* <!-- between -8760 hours and now --> */ -}}
      {{- if and ($ts.Before now) (lt $range_prev_diff.Hours 8760) -}}
        {{- $display = 1 -}}
      {{- end -}}
    {{- else if eq $date "next_all" -}} <!-- date = next_all -->
      {{- if $ts.After now -}}
        {{- $display = 1 -}}
      {{- end -}}
    {{- else if eq $date "prev_all" -}} <!-- date = prev_all -->
      {{- if $ts.Before now -}}
        {{- $display = 1 -}}
      {{- end -}}
    {{- else if eq $date "all" -}} <!-- date = all -->
      {{- $display = 1 -}}
    {{- end -}}
  {{- end -}}

  {{- /* <!-- display event only if conditions before met --> */ -}}
  {{- if eq $display 1 -}}
    {{- /* <!-- show month in headline if this is its first occurence --> */ -}}
    {{- if ne $month_no $month_counter -}} <!-- does the current month occur the first time? -->
      {{- if ne $month_counter "0" -}} <!-- close <ul> if not first occasion -->
        </div>
      {{- end -}}
      <h4 class="mb-3">{{ $month }}</h4> <!-- print month 'year -->
      <div class="mb-5">
      {{- $month_counter = $month_no -}} <!-- update month counter to current month -->
    {{- end -}}

    {{ partial "event" (dict "context" . "day" $day "end_day" $end_day "title" $title "homepage" $homepage "city" $city) }}
  {{- end -}}
  {{- /* <!-- /display event --> */ -}}
{{- end -}} <!-- /range all events -->
</div>
